<html>
<head>
	<title>Requireris</title>
</head>
<body>
	<h1>Index</h1>

	<h2>Add key</h2>
	<form method="POST" action="/key">
		<input type="textfield" name="name" />
		<input type="textfield" name="key" />
		<input type="submit" />
	</form>

	<h1>Liste</h1>
	<div id="keys">
		<% if @key != nil %>
		<% for @k in @key %>
		<div id="key">
			<span id="name"><%= @k.name %></span> - <span id="otp"></span>
		</div>
		<% end %>
		<% end %>
	</div>
	<script type="text/javascript">
	var timer = 0;
	var t;
	function Init() {
		var date = new Date;
		tt = setInterval(Clock, 1000);
		if (date.getSeconds() === 30 || date.getSeconds() == 0) {
			Clock();
		} else {
			var savedTime = date.getSeconds();
			if (savedTime > 30) {
				savedTime -= 30;
			}
			Clock();
			timer = 30-savedTime;
		}
	}
	function SendASP() {
		xmlhttp = new XMLHttpRequest();
		xmlhttp.open("GET", "/otp", false);
		xmlhttp.send(null);
		return (eval(xmlhttp.responseText));
	}
	function ActualizeKeys() {
		tokens = SendASP();
		console.log(tokens);
		var keys = document.getElementById('keys').children;
		for (var i = keys.length - 1; i >= 0; i--) {
			keys[i].children[1].innerText = tokens[i];
		};
	}
	function Clock() {
		if (timer == 0) {
			ActualizeKeys();
			timer = 30;
		}
		console.log(timer);
		timer--;
	}
	Init();
	</script>
</body>
</hmtl>